-- UILibrary.lua (com PlayerInfo + Search + Spectate integrados)

local UILibrary = {}

local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")

local Camera = workspace.CurrentCamera

local function CreateInstance(class, props)
    local obj = Instance.new(class)
    for k, v in pairs(props) do
        obj[k] = v
    end
    return obj
end

function UILibrary:CreateWindow(title)
    local ScreenGui = CreateInstance("ScreenGui", {
        Name = "CustomUI",
        ResetOnSpawn = false,
        Parent = game:GetService("CoreGui")
    })

    local MainFrame = CreateInstance("Frame", {
        Name = "MainFrame",
        BackgroundColor3 = Color3.fromRGB(20, 20, 20),
        Size = UDim2.new(0, 600, 0, 400),
        Position = UDim2.new(0.5, -300, 0.5, -200),
        AnchorPoint = Vector2.new(0.5, 0.5),
        BorderSizePixel = 0,
        Parent = ScreenGui
    })

    local UIPadding = CreateInstance("UIPadding", {
        PaddingLeft = UDim.new(0, 160),
        Parent = MainFrame
    })

    local Title = CreateInstance("TextLabel", {
        Text = title or "Window",
        Font = Enum.Font.GothamBold,
        TextSize = 20,
        TextColor3 = Color3.new(1, 1, 1),
        BackgroundTransparency = 1,
        Size = UDim2.new(1, 0, 0, 30),
        Parent = MainFrame
    })

    local TabButtons = CreateInstance("Frame", {
        Name = "TabButtons",
        BackgroundTransparency = 1,
        Size = UDim2.new(0, 150, 1, 0),
        Position = UDim2.new(0, 0, 0, 0),
        ZIndex = 2,
        Parent = MainFrame
    })

    local ContentFrame = CreateInstance("Frame", {
        Name = "ContentFrame",
        BackgroundTransparency = 1,
        Size = UDim2.new(1, -160, 1, -40),
        Position = UDim2.new(0, 160, 0, 40),
        Parent = MainFrame
    })

    local PlayerInfoPanel = CreateInstance("Frame", {
        Name = "PlayerInfoPanel",
        BackgroundColor3 = Color3.fromRGB(30, 30, 30),
        Size = UDim2.new(0, 150, 0, 400),
        Position = UDim2.new(0, -150, 0, 0),
        BorderSizePixel = 0,
        Parent = MainFrame
    })

    local Username = CreateInstance("TextLabel", {
        Name = "Username",
        Text = LocalPlayer.Name,
        Font = Enum.Font.Gotham,
        TextSize = 14,
        TextColor3 = Color3.fromRGB(255, 255, 255),
        BackgroundTransparency = 1,
        Size = UDim2.new(1, 0, 0, 20),
        Position = UDim2.new(0, 0, 0, 60),
        Parent = PlayerInfoPanel
    })

    local HealthLabel = CreateInstance("TextLabel", {
        Name = "HealthLabel",
        Text = "Health: 100",
        Font = Enum.Font.Gotham,
        TextSize = 14,
        TextColor3 = Color3.fromRGB(255, 255, 255),
        BackgroundTransparency = 1,
        Size = UDim2.new(1, 0, 0, 20),
        Position = UDim2.new(0, 0, 0, 80),
        Parent = PlayerInfoPanel
    })

    local SpectateToggle = CreateInstance("TextButton", {
        Text = "Spectate",
        Font = Enum.Font.Gotham,
        TextSize = 14,
        BackgroundColor3 = Color3.fromRGB(50, 50, 50),
        TextColor3 = Color3.new(1, 1, 1),
        Size = UDim2.new(1, -10, 0, 30),
        Position = UDim2.new(0, 5, 0, 110),
        Parent = PlayerInfoPanel
    })

    local SearchBox = CreateInstance("TextBox", {
        PlaceholderText = "Search Player",
        Font = Enum.Font.Gotham,
        TextSize = 14,
        BackgroundColor3 = Color3.fromRGB(40, 40, 40),
        TextColor3 = Color3.new(1, 1, 1),
        Size = UDim2.new(1, -10, 0, 30),
        Position = UDim2.new(0, 5, 0, 160),
        Parent = PlayerInfoPanel
    })

    local SelectedPlayerInfo = CreateInstance("TextLabel", {
        Text = "No player selected",
        Font = Enum.Font.Gotham,
        TextSize = 12,
        TextWrapped = true,
        TextColor3 = Color3.fromRGB(255, 255, 255),
        BackgroundTransparency = 1,
        Size = UDim2.new(1, -10, 0, 100),
        Position = UDim2.new(0, 5, 0, 200),
        Parent = PlayerInfoPanel
    })

    -- Drag logic
    local dragging, dragInput, dragStart, startPos
    MainFrame.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
            dragStart = input.Position
            startPos = MainFrame.Position

            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    dragging = false
                end
            end)
        end
    end)

    MainFrame.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement then
            dragInput = input
        end
    end)

    UserInputService.InputChanged:Connect(function(input)
        if input == dragInput and dragging then
            local delta = input.Position - dragStart
            MainFrame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
        end
    end)

    -- Health update loop
    RunService.RenderStepped:Connect(function()
        local character = LocalPlayer.Character
        local humanoid = character and character:FindFirstChildWhichIsA("Humanoid")
        if humanoid then
            HealthLabel.Text = "Health: " .. math.floor(humanoid.Health)
        end
    end)

    local spectating = false
    local spectatedPlayer = nil

    SpectateToggle.MouseButton1Click:Connect(function()
        spectating = not spectating
        if spectating and spectatedPlayer and spectatedPlayer.Character then
            Camera.CameraSubject = spectatedPlayer.Character:FindFirstChildWhichIsA("Humanoid")
        else
            Camera.CameraSubject = LocalPlayer.Character:FindFirstChildWhichIsA("Humanoid")
        end
    end)

    SearchBox.FocusLost:Connect(function()
        local text = SearchBox.Text:lower()
        for _, player in ipairs(Players:GetPlayers()) do
            if player ~= LocalPlayer and (player.Name:lower():find(text) or player.DisplayName:lower():find(text)) then
                spectatedPlayer = player
                SelectedPlayerInfo.Text = string.format("%s\nID: %s", player.Name, player.UserId)
                if spectating then
                    Camera.CameraSubject = player.Character and player.Character:FindFirstChildWhichIsA("Humanoid")
                end
                break
            end
        end
    end)

    Players.PlayerRemoving:Connect(function(player)
        if player == spectatedPlayer then
            spectatedPlayer = nil
            spectating = false
            SelectedPlayerInfo.Text = "No player selected"
            Camera.CameraSubject = LocalPlayer.Character:FindFirstChildWhichIsA("Humanoid")
        end
    end)

    return {
        MainFrame = MainFrame,
        AddTab = function(self, name)
            local TabButton = CreateInstance("TextButton", {
                Text = name,
                Font = Enum.Font.Gotham,
                TextSize = 14,
                TextColor3 = Color3.new(1, 1, 1),
                BackgroundColor3 = Color3.fromRGB(50, 50, 50),
                Size = UDim2.new(1, -10, 0, 30),
                Position = UDim2.new(0, 5, 0, #TabButtons:GetChildren() * 35),
                Parent = TabButtons
            })

            local TabFrame = CreateInstance("Frame", {
                BackgroundTransparency = 1,
                Size = UDim2.new(1, 0, 1, 0),
                Visible = false,
                Parent = ContentFrame
            })

            TabButton.MouseButton1Click:Connect(function()
                for _, v in ipairs(ContentFrame:GetChildren()) do
                    if v:IsA("Frame") then
                        v.Visible = false
                    end
                end
                TabFrame.Visible = true
            end)

            return TabFrame
        end
    }
end

return UILibrary
